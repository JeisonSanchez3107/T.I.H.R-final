{% load static %}
{% load json_filters %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Comparte tus ideas de muebles artesanales en Tu Idea Hecha Realidad. Convierte tu creatividad en productos reales fabricados por artesanos colombianos.">
  <meta name="keywords" content="ideas muebles, dise√±os personalizados, muebles a medida, ideas artesanales, creatividad muebles">
  <meta name="author" content="Tu Idea Hecha Realidad">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Publicar Idea - Tu Idea Hecha Realidad">
  <meta property="og:description" content="Comparte tus ideas de muebles y convi√©rtelas en realidad.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="es_CO">
  
  <title>Tu Idea Hecha Realidad</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'core/css/styles.css' %}">
  <link rel="stylesheet" href="{% static 'core/css/idea.css' %}">
  <link rel="stylesheet" href="{% static 'core/css/responsive.css' %}">
  <script src="{% static 'core/javascript/sidebar-toggle.js' %}"></script>
</head>
<body>

<!-- Overlay para cerrar sidebar en m√≥vil -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- BARRA LATERAL (MEN√ö + FILTROS) -->
<div class="sidebar">
    <div class="sidebar-user-info">
        <a href="{% url 'perfilUsuario' %}" class="user-avatar-link">
            {% if usuario.foto_perfil %}
                <img src="{{ usuario.foto_perfil.url }}" alt="Foto de perfil" width="50" height="50" style="border-radius: 50%; border: 2px solid #A0662F; object-fit: cover;">
            {% else %}
                <img src="{% static 'core/img/Perfil.png' %}" alt="Logo" width="50" height="50" style="border-radius: 50%; border: 2px solid #A0662F;">
            {% endif %}
        </a>
        <span class="username-display">{{ usuario.usernameCliente }}</span>
    </div>
  <ul>
    <li><a href="{% url 'productos' %}">Gangazos</a></li>
    <li><a href="{% url 'idea' %}">Crear Idea</a></li>
    <li><a href="{% url 'mis_pedidos' %}">Mis Pedidos</a></li>
    <li><a href="{% url 'contact' %}">Cont√°ctenos</a></li>
    <li><a href="{% url 'comentarios' %}">Comentarios</a></li>
    <li><a href="{% url 'logout' %}" class="logout-button">Cerrar Sesi√≥n</a></li>
  </ul>

  <!-- FILTROS -->
  <div class="filtros">
    <h2 for="categoria" class="h2-side">Categor√≠a:</h2>
    <select id="categoria">
        <option value="">Elegir Categoria</option> 
        <option value="carpinteria">Armarios</option>
        <option value="marroquineria">Escritorios</option>
        <option value="vidrieria">Sillas</option>
        <option value="metaleria">Cajoneras</option>
        <option value="ceramica">Mesas</option>
        <option value="tapiceria">Utensilios</option>
    </select>

    <button onclick="aplicarFiltros()">Aplicar filtros</button>
  </div>
</div>

<!-- CONTENIDO PRINCIPAL -->
<div class="main-content-wrapper">
  <header>
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <h1 class="div" style="text-align: center;">
      <img src="{% static 'core/img/Gemini_Generated_Image_tzay6utzay6utzay.jfif' %}" alt="Logo" width="75" height="75">
      Tu Idea Hecha Realidad
    </h1>
  </header>

  <!-- Aqu√≠ va tu contenido: art√≠culos, productos, etc. -->
   <section>
      <section class="seccion-at">
        <h2>Agregar una Nueva Idea a Crear</h2>
        <p>¬øTienes una idea que quieres desarrollar o compartir? Completa el siguiente formulario:</p>
        
        <form method="post" enctype="multipart/form-data" class="idea-form" id="ideaForm">
          {% csrf_token %}
          <!-- T√≠tulo -->
          <div class="form-group">
            <label for="id_titulo">T√≠tulo de tu idea:</label>
            {{ form.titulo }}
          </div>

          <!-- Categor√≠a (selecci√≥n m√∫ltiple) -->
          <div class="form-group">
            <label for="id_categoria">Categor√≠a del mueble:</label>
            {{ form.categoria }}
          </div>

          <!-- Medidas din√°micas -->
          <div class="form-group" id="medidas-section" style="display:none; text-align:center;">
            <label><b>Medidas personalizadas</b></label>
            <div id="medidas-campos" style="display: flex; flex-direction: column; align-items: center;"></div>
            <div id="medidas-recomendacion" class="medidas-recomendacion"></div>
            <input type="hidden" name="medidas" id="id_medidas">
            <div id="medidas-error" style="color:red; font-weight:bold; display:none;"></div>
          </div>

          <!-- Descripci√≥n mejorada -->
          <div class="form-group">
            <label for="id_descripcion">Descripci√≥n detallada:</label>
            <textarea 
              name="descripcion" 
              id="id_descripcion" 
              placeholder="Describe tu idea detalladamente... ¬øQu√© quieres crear? ¬øQu√© caracter√≠sticas deber√≠a tener?"
              required
            >{{ form.descripcion.value|default:'' }}</textarea>
          </div>

          <!-- Imagen -->
          <div class="form-group">
            <label for="id_imagen">Adjuntar imagen (opcional):</label>
            {{ form.imagen }}
          </div>

          <!-- Modelo 3D -->
          <div class="form-group">
            <label for="id_modelo_3d">Adjuntar Modelo 3D .glb (opcional):</label>
            {{ form.modelo_3d }}
            <small class="form-text">Formatos aceptados: .glb</small>
          </div>
          <button type="submit" class="articulo-boton">Publicar Idea</button>
        </form>
      </section>
      <br>
      
      <!-- Secci√≥n de Mis Ideas -->
      {% if mis_ideas %}
      <section class="seccion-at">
        <h2>Mis Ideas</h2>
        <div class="contenedor-articulos">
          {% for idea in mis_ideas %}
            <div class="articulo {% if idea.estado == 'en_proceso' %}en-proceso{% elif idea.estado == 'completada' %}completada{% elif idea.estado == 'finalizada' %}finalizada{% endif %}" style="{% if idea.estado == 'finalizada' %}border-left: 4px solid #6f42c1;{% endif %}">
              <div class="contenido-articulo">
                <h3>{{ idea.titulo }}</h3>
                <p>{{ idea.descripcion }}</p>
                <p><strong>Estado:</strong> {{ idea.get_estado_display }}</p>
                {% if idea.empresa_asignada %}
                <p><strong>Empresa asignada:</strong> {{ idea.empresa_asignada.usernameEmpresa }}</p>
                {% endif %}
                
                <!-- Los mensajes y permisos ahora se manejan en el modal de notificaciones -->
                
                <!-- Bot√≥n de editar solo si est√° pendiente -->
                {% if idea.estado == 'pendiente' %}
                <button type="button" 
                        class="articulo-boton btn-editar-idea" 
                        data-id="{{ idea.id }}" 
                        data-titulo="{{ idea.titulo|escapejs }}" 
                        data-descripcion="{{ idea.descripcion|escapejs }}" 
                        data-categoria="{{ idea.categoria }}" 
                        data-medidas="{{ idea.medidas_json|escapejs }}" 
                        data-veces="{{ idea.veces_editada|default:0 }}" 
                        data-imagen="{{ idea.imagen.url|default:'' }}" 
                        style="background-color: #3b82f6; margin-top: 10px;">
                  Editar Idea {% if idea.veces_editada > 0 %}({{ idea.veces_editada }}/3){% endif %}
                </button>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
      <br>
      {% endif %}
      
      <section class="seccion-at">
        <h2>Ideas Publicadas</h2>
        {% if ideas %}
          <div class="contenedor-articulos">
            {% for idea in ideas %}
              <div class="articulo {% if idea.estado == 'en_proceso' %}en-proceso{% elif idea.estado == 'completada' %}completada{% endif %}">
                <div class="contenido-articulo">
                  <!-- Header con avatar y nombre del autor -->
                  <div class="idea-header">
                    <div class="idea-usuario">
                      <div class="usuario-avatar">
                        {% if idea.usuario.foto_perfil %}
                          <img src="{{ idea.usuario.foto_perfil.url }}" alt="{{ idea.autor }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                          <img src="{% static 'core/img/Perfil.png' %}" alt="{{ idea.autor }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% endif %}
                      </div>
                      <div class="usuario-info">
                        <h4>{{ idea.autor }}</h4>
                        <span class="idea-fecha">{{ idea.fecha_creacion|date:"d/m/Y" }}</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Contenido de la idea -->
                  <h3>{{ idea.titulo }}</h3>
                  <p>{{ idea.descripcion }}</p>
                  <p><strong>Estado:</strong> {{ idea.get_estado_display }}</p>
                  {% if idea.empresa_asignada %}
                  <p><strong>Empresa asignada:</strong> {{ idea.empresa_asignada.usernameEmpresa }}</p>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>A√∫n no hay ideas publicadas. ¬°S√© el primero en compartir la tuya!</p>
        {% endif %}
      </section>
  </section>


  <footer>
    <div class="footer-content">
        <div class="footer-section">
            <h3 class="footer-title">üìû Cont√°ctenos</h3>
            <div class="footer-info">
                <i>üìû</i>
                <span>+57 300 123 4567</span>
            </div>
            <div class="footer-info">
                <i>‚úâÔ∏è</i>
                <span>info@gangasca-tirr.com</span>
            </div>
        </div>
        
        <div class="footer-section">
            <h3 class="footer-title">üìç Direcci√≥n</h3>
            <div class="footer-info">
                <i>üìç</i>
                <span>Carrera 45 P. 26-85<br>RoyalA, Colombia</span>
            </div>
        </div>
        
        <div class="footer-section">
            <h3 class="footer-title">üåê S√≠guenos</h3>
            <div class="footer-social">
                <a href="https://www.instagram.com/tu_idea_hecha_realidad?igsh=Y3ByM2lyZGcwNHVy" class="social-icon-img" aria-label="Instagram">
                        <img src="{% static 'core/img/Instagram.webp' %}" alt="Instagram" class="social-logo" width="40" height="40">
                    </a>
                    <a href="https://www.facebook.com/share/1ACEVZbZHV/" class="social-icon-img" aria-label="Facebook">
                        <img src="{% static 'core/img/Facebook.png' %}" alt="Facebook" class="social-logo" width="40" height="40">
                    </a>
            </div>
        </div>
    </div>
    
    <div class="footer-bottom">
        <p>¬© 2025 Tu Idea Herba Realidad - Todos los derechos reservados</p>
    </div>
  </footer>
</div>

<script src="{% static 'core/javascript/Carrito.js' %}"></script>
<script>
  function aplicarFiltros() {
        const categoria = document.getElementById('categoria').value;
        console.log('Aplicando filtros y redirigiendo...');
        console.log('Categor√≠a seleccionada:', categoria);

        if (categoria) {
            const urlRedireccion = '/' + categoria + '/';
            
            console.log('Redirigiendo a:', urlRedireccion);
            window.location.href = urlRedireccion;
        } else {
            window.location.href = '/productos/'; 
        }
    }

  // Funci√≥n para responder a la empresa
  function responderEmpresa(ideaId) {
    const respuesta = prompt('Escribe tu respuesta a la empresa:');
    if (respuesta && respuesta.trim()) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const formData = new FormData();
      formData.append('respuesta', respuesta.trim());
      
      fetch(`/idea/responder/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar la respuesta');
      });
    }
  }

  // Funci√≥n para otorgar permiso de publicaci√≥n
  function otorgarPermiso(ideaId) {
    if (confirm('¬øEst√°s seguro de que deseas otorgar permiso a la empresa para publicar tu idea como producto en la tienda?')) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(`/idea/otorgar-permiso/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al otorgar el permiso');
      });
    }
  }

  // Funci√≥n para revocar permiso de publicaci√≥n
  function revocarPermiso(ideaId) {
    if (confirm('¬øEst√°s seguro de que deseas revocar el permiso de publicaci√≥n?')) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(`/idea/revocar-permiso/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al revocar el permiso');
      });
    }
  }

// Medidas y recomendaciones por categor√≠a
const CATEGORIA_MEDIDAS = {
  mesas: {
    campos: [
      {nombre: 'Altura de la Superficie', campo: 'altura_superficie', unidad: 'cm', estandar: '73 - 75'},
      {nombre: 'Profundidad de Escritorio (Min.)', campo: 'profundidad_escritorio', unidad: 'cm', estandar: '60'},
      {nombre: 'Espacio Libre para Piernas (Altura)', campo: 'espacio_piernas', unidad: 'cm', estandar: '65 (m√≠nimo)'},
      {nombre: 'Ancho por Persona (Comedor)', campo: 'ancho_persona', unidad: 'cm', estandar: '60 (m√≠nimo)'}
    ],
    recomendacion: 'La altura es crucial para la ergonom√≠a; la diferencia ideal entre la mesa y el asiento de la silla es de <b>30 cm</b>.'
  },
  sillas: {
    campos: [
      {nombre: 'Altura del Asiento', campo: 'altura_asiento', unidad: 'cm', estandar: '40 - 45'},
      {nombre: 'Profundidad del Asiento', campo: 'profundidad_asiento', unidad: 'cm', estandar: '42 - 49'},
      {nombre: 'Ancho del Asiento (Min.)', campo: 'ancho_asiento', unidad: 'cm', estandar: '42'}
    ],
    recomendacion: 'La altura del asiento debe permitir que los pies toquen el suelo y las rodillas formen un √°ngulo de 90¬∞. Debe haber soporte lumbar.'
  },
  armarios: {
    campos: [
      {nombre: 'Profundidad Total (Ropa Colgada)', campo: 'profundidad_total', unidad: 'cm', estandar: '55 - 60'},
      {nombre: 'Altura Libre para Ropa Corta', campo: 'altura_ropa_corta', unidad: 'cm', estandar: '90 - 110'},
      {nombre: 'Altura Libre para Ropa Larga', campo: 'altura_ropa_larga', unidad: 'cm', estandar: '150 - 170'},
      {nombre: 'Altura de Estantes (Separaci√≥n)', campo: 'altura_estantes', unidad: 'cm', estandar: '30 - 40'}
    ],
    recomendacion: 'La profundidad de 60 cm es la necesaria para que una percha cuelgue sin que la ropa choque contra la puerta.'
  },
  cajoneras: {
    campos: [
      {nombre: 'Profundidad Total', campo: 'profundidad_total', unidad: 'cm', estandar: '40 - 60'},
      {nombre: 'Altura Frontal de Caj√≥n Chico', campo: 'altura_cajon_chico', unidad: 'cm', estandar: '10 - 15'},
      {nombre: 'Altura Frontal de Caj√≥n Grande', campo: 'altura_cajon_grande', unidad: 'cm', estandar: '20 - 30'}
    ],
    recomendacion: 'Se requiere una buena calidad de <b>correderas</b> que soporten la carga y permitan la extracci√≥n completa del caj√≥n.'
  },
  escritorios: {
    campos: [
      {nombre: 'Altura de la Superficie', campo: 'altura_superficie', unidad: 'cm', estandar: '70 - 75'},
      {nombre: 'Profundidad', campo: 'profundidad', unidad: 'cm', estandar: '60 - 80'},
      {nombre: 'Ancho (M√≠nimo)', campo: 'ancho', unidad: 'cm', estandar: '100 - 120'}
    ],
    recomendacion: 'Debe proporcionar suficiente profundidad para mantener la pantalla a una distancia c√≥moda y tener espacio para apoyar los antebrazos.'
  },
  utensilios: {
    campos: [],
    recomendacion: ''
  }
};

const categoriaSelect = document.getElementById('id_categoria');
const medidasSection = document.getElementById('medidas-section');
const medidasCampos = document.getElementById('medidas-campos');
const medidasRecomendacion = document.getElementById('medidas-recomendacion');
const medidasInput = document.getElementById('id_medidas');
const medidasError = document.getElementById('medidas-error');

function renderMedidasCampos(categoria) {
  medidasCampos.innerHTML = '';
  medidasError.style.display = 'none';
  if (!categoria || !CATEGORIA_MEDIDAS[categoria] || CATEGORIA_MEDIDAS[categoria].campos.length === 0) {
    medidasSection.style.display = 'none';
    medidasInput.value = '';
    medidasRecomendacion.innerHTML = '';
    return;
  }
  medidasSection.style.display = 'block';
  CATEGORIA_MEDIDAS[categoria].campos.forEach(function(campo) {
    const div = document.createElement('div');
    div.className = 'medida-campo';
    div.style.display = 'flex';
    div.style.flexDirection = 'column';
    div.style.alignItems = 'center';
    div.style.marginBottom = '12px';
    div.innerHTML = `<label style='margin-bottom:4px;'><b>${campo.nombre}</b> <span style='color:#888;'>(Estandar: ${campo.estandar} ${campo.unidad})</span></label><input type='number' min='0' step='any' class='input-medida' name='${campo.campo}' placeholder='Tu medida en ${campo.unidad}' required style='margin-bottom:8px; text-align:center; width: 220px;'> <span>${campo.unidad}</span>`;
    medidasCampos.appendChild(div);
  });
  medidasRecomendacion.innerHTML = `<div class='recomendacion-box'><b>Recomendaci√≥n:</b> ${CATEGORIA_MEDIDAS[categoria].recomendacion}</div>`;
}

categoriaSelect.addEventListener('change', function() {
  renderMedidasCampos(this.value);
});

// Validaci√≥n antes de enviar
const ideaForm = document.getElementById('ideaForm');
ideaForm.addEventListener('submit', function(e) {
  const categoria = categoriaSelect.value;
  if (!categoria || !CATEGORIA_MEDIDAS[categoria]) return;
  const campos = CATEGORIA_MEDIDAS[categoria].campos;
  let medidas = {};
  let incompletos = [];
  campos.forEach(function(campo) {
    const input = ideaForm.querySelector(`[name='${campo.campo}']`);
    if (!input || !input.value) {
      incompletos.push(campo.nombre);
    } else {
      medidas[campo.campo] = input.value;
    }
  });
  if (incompletos.length > 0) {
    e.preventDefault();
    medidasError.innerText = 'Termina de adjuntar las medidas necesarias para poder publicar tu idea.';
    medidasError.style.display = 'block';
    return false;
  }
  medidasInput.value = JSON.stringify(medidas);
  medidasError.style.display = 'none';
});
// Render inicial si hay valor
if (categoriaSelect.value) renderMedidasCampos(categoriaSelect.value);

// Event listener para los botones de editar
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM Cargado - Buscando botones de editar');
  const botonesEditar = document.querySelectorAll('.btn-editar-idea');
  console.log('Botones encontrados:', botonesEditar.length);
  
  botonesEditar.forEach(function(boton) {
    boton.addEventListener('click', function(e) {
      e.preventDefault();
      console.log('Bot√≥n clickeado');
      
      const ideaId = this.getAttribute('data-id');
      const titulo = this.getAttribute('data-titulo');
      const descripcion = this.getAttribute('data-descripcion');
      const categoria = this.getAttribute('data-categoria');
      const medidasStr = this.getAttribute('data-medidas');
      const vecesEditada = parseInt(this.getAttribute('data-veces') || '0');
      const imagenUrl = this.getAttribute('data-imagen');
      
      console.log('Datos:', {ideaId, titulo, categoria, vecesEditada});
      
      let medidas = null;
      if (medidasStr && medidasStr !== 'null' && medidasStr !== 'None') {
        try {
          medidas = JSON.parse(medidasStr);
        } catch(err) {
          console.error('Error parseando medidas:', err);
        }
      }
      
      abrirModalEditar(ideaId, titulo, descripcion, categoria, medidas, vecesEditada, imagenUrl);
    });
  });
});
</script>

<!-- Modal para editar idea -->
<div id="modalEditarIdea" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 700px; background: white; border-radius: 12px; padding: 30px; margin: 50px auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
    <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="color: #A0662F; margin: 0;">Editar Idea <span id="editContadorEdiciones" style="font-size: 14px; color: #666;"></span></h2>
      <button class="close" onclick="cerrarModalEditar()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #666;">&times;</button>
    </div>
    <div class="modal-body">
      <form id="formEditarIdea" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" id="editIdeaId" name="idea_id">
        <input type="hidden" id="editVecesEditada" name="veces_editada">
        <input type="hidden" name="medidas" id="edit_id_medidas">
        
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="editTitulo" style="display: block; margin-bottom: 8px; font-weight: 600;">T√≠tulo:</label>
          <input type="text" id="editTitulo" name="titulo" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        </div>
        
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="editDescripcion" style="display: block; margin-bottom: 8px; font-weight: 600;">Descripci√≥n:</label>
          <textarea id="editDescripcion" name="descripcion" required rows="5" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
        </div>
        
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="editCategoria" style="display: block; margin-bottom: 8px; font-weight: 600;">Categor√≠a:</label>
          <select id="editCategoria" name="categoria" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            <option value="">Seleccionar categor√≠a</option>
            <option value="mesas">Mesas</option>
            <option value="sillas">Sillas</option>
            <option value="armarios">Armarios</option>
            <option value="cajoneras">Cajoneras</option>
            <option value="escritorios">Escritorios</option>
            <option value="utensilios">Utensilios</option>
          </select>
        </div>
        
        <!-- Medidas din√°micas para edici√≥n -->
        <div class="form-group" id="edit-medidas-section" style="display:none; margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: 600;">Medidas personalizadas:</label>
          <div id="edit-medidas-campos" style="background: #f9f9f9; padding: 15px; border-radius: 6px;"></div>
          <div id="edit-medidas-recomendacion" style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;"></div>
        </div>
        
        <div class="form-group" style="margin-bottom: 20px;">
          <label for="editImagen" style="display: block; margin-bottom: 8px; font-weight: 600;">Cambiar imagen (opcional):</label>
          <div id="imagenActualContainer" style="margin-bottom: 10px; display: none;">
            <p style="font-size: 12px; color: #666; margin-bottom: 5px;">Imagen actual:</p>
            <img id="imagenActualPreview" src="" alt="Imagen actual" style="max-width: 200px; max-height: 150px; border-radius: 6px; border: 2px solid #ddd;">
          </div>
          <input type="file" id="editImagen" name="imagen" accept="image/*" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
          <small style="color: #666; font-size: 12px;">Sube una nueva imagen si deseas cambiar la actual</small>
        </div>
        
        <div class="modal-actions" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
          <button type="button" class="btn-modal-cancelar" onclick="cerrarModalEditar()" style="padding: 10px 24px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
            Cancelar
          </button>
          <button type="submit" class="btn-modal-guardar" style="padding: 10px 24px; background: #A0662F; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
            Guardar Cambios
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.5);
}

.btn-modal-cancelar:hover {
  background: #5a6268 !important;
}

.btn-modal-guardar:hover {
  background: #8a5625 !important;
}
</style>

<script>
function abrirModalEditar(ideaId, titulo, descripcion, categoria, medidas, vecesEditada, imagenUrl) {
  console.log('abrirModalEditar llamada con:', {ideaId, titulo, categoria, vecesEditada, medidas});
  console.log('Tipo de medidas:', typeof medidas, 'Valor:', medidas);
  
  // Validar l√≠mite de ediciones
  if (vecesEditada >= 3) {
    alert('Has alcanzado el l√≠mite de 3 ediciones para esta idea.');
    return;
  }
  
  document.getElementById('editIdeaId').value = ideaId;
  document.getElementById('editTitulo').value = titulo;
  document.getElementById('editDescripcion').value = descripcion;
  document.getElementById('editCategoria').value = categoria;
  document.getElementById('editVecesEditada').value = vecesEditada;
  
  // Guardar las medidas en un atributo data para usarlas al cambiar de categor√≠a
  const medidasStr = typeof medidas === 'object' ? JSON.stringify(medidas) : medidas;
  document.getElementById('editIdeaId').dataset.medidas = medidasStr;
  console.log('Medidas guardadas en dataset:', medidasStr);
  
  // Mostrar contador de ediciones
  const edicionesRestantes = 3 - vecesEditada;
  document.getElementById('editContadorEdiciones').textContent = `(${vecesEditada}/3 ediciones - ${edicionesRestantes} restantes)`;
  
  // Mostrar imagen actual si existe
  const imagenContainer = document.getElementById('imagenActualContainer');
  const imagenPreview = document.getElementById('imagenActualPreview');
  if (imagenUrl && imagenUrl !== '') {
    imagenPreview.src = imagenUrl;
    imagenContainer.style.display = 'block';
  } else {
    imagenContainer.style.display = 'none';
  }
  
  // Renderizar medidas para la categor√≠a CON LOS VALORES ACTUALES
  console.log('Llamando a renderEditMedidasCampos con medidas:', medidas);
  renderEditMedidasCampos(categoria, medidas);
  
  // Mostrar el modal
  document.getElementById('modalEditarIdea').style.display = 'block';
  console.log('Modal abierto');
}

function cerrarModalEditar() {
  document.getElementById('modalEditarIdea').style.display = 'none';
  document.getElementById('edit-medidas-campos').innerHTML = '';
  document.getElementById('edit-medidas-section').style.display = 'none';
}

// Renderizar campos de medidas en el modal de edici√≥n
function renderEditMedidasCampos(categoria, medidasActuales) {
  const medidasCampos = document.getElementById('edit-medidas-campos');
  const medidasSection = document.getElementById('edit-medidas-section');
  const medidasRecomendacion = document.getElementById('edit-medidas-recomendacion');
  
  console.log('renderEditMedidasCampos - categoria:', categoria, 'medidas:', medidasActuales);
  
  medidasCampos.innerHTML = '';
  
  if (!categoria || !CATEGORIA_MEDIDAS[categoria] || CATEGORIA_MEDIDAS[categoria].campos.length === 0) {
    medidasSection.style.display = 'none';
    return;
  }
  
  medidasSection.style.display = 'block';
  
  // Parsear medidasActuales si es string
  let medidas = {};
  if (medidasActuales) {
    if (typeof medidasActuales === 'string') {
      try {
        medidas = JSON.parse(medidasActuales);
      } catch(e) {
        console.error('Error parseando medidas:', e);
      }
    } else if (typeof medidasActuales === 'object') {
      medidas = medidasActuales;
    }
  }
  console.log('Medidas parseadas:', medidas);
  
  CATEGORIA_MEDIDAS[categoria].campos.forEach(function(campo) {
    const valorActual = medidas[campo.campo] || '';
    console.log('Campo:', campo.campo, 'Valor actual:', valorActual);
    
    const div = document.createElement('div');
    div.className = 'medida-campo';
    div.style.marginBottom = '12px';
    
    const label = document.createElement('label');
    label.style.display = 'block';
    label.style.marginBottom = '4px';
    label.style.fontWeight = '600';
    label.innerHTML = `${campo.nombre} <span style='color:#888; font-weight: normal;'>(Est√°ndar: ${campo.estandar} ${campo.unidad})</span>`;
    
    const inputContainer = document.createElement('div');
    inputContainer.style.display = 'flex';
    inputContainer.style.alignItems = 'center';
    inputContainer.style.gap = '8px';
    
    const input = document.createElement('input');
    input.type = 'number';
    input.min = '0';
    input.step = 'any';
    input.className = 'edit-input-medida';
    input.name = campo.campo;
    input.value = valorActual;
    input.placeholder = `Tu medida en ${campo.unidad}`;
    input.required = true;
    input.style.flex = '1';
    input.style.padding = '8px';
    input.style.border = '1px solid #ddd';
    input.style.borderRadius = '4px';
    input.style.fontSize = '14px';
    
    const unidad = document.createElement('span');
    unidad.style.color = '#666';
    unidad.textContent = campo.unidad;
    
    inputContainer.appendChild(input);
    inputContainer.appendChild(unidad);
    
    div.appendChild(label);
    div.appendChild(inputContainer);
    medidasCampos.appendChild(div);
  });
  
  medidasRecomendacion.innerHTML = `<strong>üí° Recomendaci√≥n:</strong> ${CATEGORIA_MEDIDAS[categoria].recomendacion}`;
  console.log('Medidas renderizadas correctamente');
}

// Actualizar medidas cuando cambie la categor√≠a en el modal de edici√≥n
document.getElementById('editCategoria').addEventListener('change', function() {
  const medidasActualesGuardadas = document.getElementById('editIdeaId').dataset.medidas;
  let medidas = null;
  if (medidasActualesGuardadas && medidasActualesGuardadas !== 'null') {
    try {
      medidas = JSON.parse(medidasActualesGuardadas);
    } catch(e) {
      console.error('Error al parsear medidas guardadas:', e);
    }
  }
  renderEditMedidasCampos(this.value, medidas);
});

// Cerrar modal al hacer clic fuera
window.onclick = function(event) {
  const modal = document.getElementById('modalEditarIdea');
  if (event.target === modal) {
    cerrarModalEditar();
  }
}

// Manejar env√≠o del formulario de edici√≥n
document.getElementById('formEditarIdea').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const categoria = document.getElementById('editCategoria').value;
  const formData = new FormData(this);
  const ideaId = document.getElementById('editIdeaId').value;
  
  // Recopilar medidas si existen
  if (CATEGORIA_MEDIDAS[categoria] && CATEGORIA_MEDIDAS[categoria].campos.length > 0) {
    let medidas = {};
    let incompletos = [];
    
    CATEGORIA_MEDIDAS[categoria].campos.forEach(function(campo) {
      const input = document.querySelector(`.edit-input-medida[name='${campo.campo}']`);
      if (!input || !input.value) {
        incompletos.push(campo.nombre);
      } else {
        medidas[campo.campo] = input.value;
      }
    });
    
    if (incompletos.length > 0) {
      alert('Por favor completa todas las medidas: ' + incompletos.join(', '));
      return false;
    }
    
    formData.set('medidas', JSON.stringify(medidas));
  }
  
  fetch(`/editar-idea/${ideaId}/`, {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      alert(data.mensaje);
      location.reload();
    } else {
      alert('Error: ' + (data.error || 'No se pudo actualizar la idea'));
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error al actualizar la idea');
  });
});
</script>

<script src="{% static 'core/javascript/sidebar-toggle.js' %}"></script>
{% include 'core/floating_buttons.html' %}
{% include 'core/modal_notificaciones.html' %}
</body>
</html>
