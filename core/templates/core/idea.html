<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- SEO Meta Tags -->
  <meta name="description" content="Comparte tus ideas de muebles artesanales en Tu Idea Hecha Realidad. Convierte tu creatividad en productos reales fabricados por artesanos colombianos.">
  <meta name="keywords" content="ideas muebles, dise√±os personalizados, muebles a medida, ideas artesanales, creatividad muebles">
  <meta name="author" content="Tu Idea Hecha Realidad">
  <meta name="robots" content="index, follow">
  
  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="Publicar Idea - Tu Idea Hecha Realidad">
  <meta property="og:description" content="Comparte tus ideas de muebles y convi√©rtelas en realidad.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="es_CO">
  
  <title>Tu Idea Hecha Realidad</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'core/css/styles.css' %}">
  <link rel="stylesheet" href="{% static 'core/css/idea.css' %}">
  <link rel="stylesheet" href="{% static 'core/css/responsive.css' %}">
  <script src="{% static 'core/javascript/sidebar-toggle.js' %}"></script>
</head>
<body>

<!-- Overlay para cerrar sidebar en m√≥vil -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- BARRA LATERAL (MEN√ö + FILTROS) -->
<div class="sidebar">
    <div class="sidebar-user-info">
        <a href="{% url 'perfilUsuario' %}" class="user-avatar-link">
            {% if usuario.foto_perfil %}
                <img src="{{ usuario.foto_perfil.url }}" alt="Foto de perfil" width="50" height="50" style="border-radius: 50%; border: 2px solid #A0662F; object-fit: cover;">
            {% else %}
                <img src="{% static 'core/img/Perfil.png' %}" alt="Logo" width="50" height="50" style="border-radius: 50%; border: 2px solid #A0662F;">
            {% endif %}
        </a>
        <span class="username-display">{{ usuario.usernameCliente }}</span>
    </div>
  <ul>
    <li><a href="{% url 'productos' %}">Gangazos</a></li>
    <li><a href="{% url 'idea' %}">Crear Idea</a></li>
    <li><a href="{% url 'mis_pedidos' %}">Mis Pedidos</a></li>
    <li><a href="{% url 'contact' %}">Cont√°ctenos</a></li>
    <li><a href="{% url 'comentarios' %}">Comentarios</a></li>
    <li><a href="{% url 'logout' %}" class="logout-button">Cerrar Sesi√≥n</a></li>
  </ul>

  <!-- FILTROS -->
  <div class="filtros">
    <h2 for="categoria" class="h2-side">Categor√≠a:</h2>
    <select id="categoria">
        <option value="">Elegir Categoria</option> 
        <option value="carpinteria">Armarios</option>
        <option value="marroquineria">Escritorios</option>
        <option value="vidrieria">Sillas</option>
        <option value="metaleria">Cajoneras</option>
        <option value="ceramica">Mesas</option>
        <option value="tapiceria">Utensilios</option>
    </select>

    <button onclick="aplicarFiltros()">Aplicar filtros</button>
  </div>
</div>

<!-- CONTENIDO PRINCIPAL -->
<div class="main-content-wrapper">
  <header>
    <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
    <h1 class="div" style="text-align: center;">
      <img src="{% static 'core/img/Gemini_Generated_Image_tzay6utzay6utzay.jfif' %}" alt="Logo" width="75" height="75">
      Tu Idea Hecha Realidad
    </h1>
  </header>

  <!-- Aqu√≠ va tu contenido: art√≠culos, productos, etc. -->
   <section>
      <section class="seccion-at">
        <h2>Agregar una Nueva Idea a Crear</h2>
        <p>¬øTienes una idea que quieres desarrollar o compartir? Completa el siguiente formulario:</p>
        
        <form method="post" enctype="multipart/form-data" class="idea-form" id="ideaForm">
          {% csrf_token %}
          <!-- T√≠tulo -->
          <div class="form-group">
            <label for="id_titulo">T√≠tulo de tu idea:</label>
            {{ form.titulo }}
          </div>

          <!-- Categor√≠a (selecci√≥n m√∫ltiple) -->
          <div class="form-group">
            <label for="id_categoria">Categor√≠a del mueble:</label>
            {{ form.categoria }}
          </div>

          <!-- Medidas din√°micas -->
          <div class="form-group" id="medidas-section" style="display:none; text-align:center;">
            <label><b>Medidas personalizadas</b></label>
            <div id="medidas-campos" style="display: flex; flex-direction: column; align-items: center;"></div>
            <div id="medidas-recomendacion" class="medidas-recomendacion"></div>
            <input type="hidden" name="medidas" id="id_medidas">
            <div id="medidas-error" style="color:red; font-weight:bold; display:none;"></div>
          </div>

          <!-- Descripci√≥n mejorada -->
          <div class="form-group">
            <label for="id_descripcion">Descripci√≥n detallada:</label>
            <textarea 
              name="descripcion" 
              id="id_descripcion" 
              placeholder="Describe tu idea detalladamente... ¬øQu√© quieres crear? ¬øQu√© caracter√≠sticas deber√≠a tener?"
              required
            >{{ form.descripcion.value|default:'' }}</textarea>
          </div>

          <!-- Imagen -->
          <div class="form-group">
            <label for="id_imagen">Adjuntar imagen (opcional):</label>
            {{ form.imagen }}
          </div>

          <!-- Modelo 3D -->
          <div class="form-group">
            <label for="id_modelo_3d">Adjuntar Modelo 3D .glb (opcional):</label>
            {{ form.modelo_3d }}
            <small class="form-text">Formatos aceptados: .glb</small>
          </div>
          <button type="submit" class="articulo-boton">Publicar Idea</button>
        </form>
      </section>
      <br>
      
      <!-- Secci√≥n de Mis Ideas -->
      {% if mis_ideas %}
      <section class="seccion-at">
        <h2>Mis Ideas</h2>
        <div class="contenedor-articulos">
          {% for idea in mis_ideas %}
            <div class="articulo {% if idea.estado == 'en_proceso' %}en-proceso{% elif idea.estado == 'completada' %}completada{% elif idea.estado == 'finalizada' %}finalizada{% endif %}" style="{% if idea.estado == 'finalizada' %}border-left: 4px solid #6f42c1;{% endif %}">
              <div class="contenido-articulo">
                <h3>{{ idea.titulo }}</h3>
                <p>{{ idea.descripcion }}</p>
                <p><strong>Estado:</strong> {{ idea.get_estado_display }}</p>
                {% if idea.empresa_asignada %}
                <p><strong>Empresa asignada:</strong> {{ idea.empresa_asignada.usernameEmpresa }}</p>
                {% endif %}
                
                <!-- Los mensajes y permisos ahora se manejan en el modal de notificaciones -->
                
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
      <br>
      {% endif %}
      
      <section class="seccion-at">
        <h2>Ideas Publicadas</h2>
        {% if ideas %}
          <div class="contenedor-articulos">
            {% for idea in ideas %}
              <div class="articulo {% if idea.estado == 'en_proceso' %}en-proceso{% elif idea.estado == 'completada' %}completada{% endif %}">
                <div class="contenido-articulo">
                  <!-- Header con avatar y nombre del autor -->
                  <div class="idea-header">
                    <div class="idea-usuario">
                      <div class="usuario-avatar">
                        {% if idea.usuario.foto_perfil %}
                          <img src="{{ idea.usuario.foto_perfil.url }}" alt="{{ idea.autor }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% else %}
                          <img src="{% static 'core/img/Perfil.png' %}" alt="{{ idea.autor }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                        {% endif %}
                      </div>
                      <div class="usuario-info">
                        <h4>{{ idea.autor }}</h4>
                        <span class="idea-fecha">{{ idea.fecha_creacion|date:"d/m/Y" }}</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Contenido de la idea -->
                  <h3>{{ idea.titulo }}</h3>
                  <p>{{ idea.descripcion }}</p>
                  <p><strong>Estado:</strong> {{ idea.get_estado_display }}</p>
                  {% if idea.empresa_asignada %}
                  <p><strong>Empresa asignada:</strong> {{ idea.empresa_asignada.usernameEmpresa }}</p>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>A√∫n no hay ideas publicadas. ¬°S√© el primero en compartir la tuya!</p>
        {% endif %}
      </section>
  </section>


  <footer>
    <div class="footer-content">
        <div class="footer-section">
            <h3 class="footer-title">üìû Cont√°ctenos</h3>
            <div class="footer-info">
                <i>üìû</i>
                <span>+57 300 123 4567</span>
            </div>
            <div class="footer-info">
                <i>‚úâÔ∏è</i>
                <span>info@gangasca-tirr.com</span>
            </div>
        </div>
        
        <div class="footer-section">
            <h3 class="footer-title">üìç Direcci√≥n</h3>
            <div class="footer-info">
                <i>üìç</i>
                <span>Carrera 45 P. 26-85<br>RoyalA, Colombia</span>
            </div>
        </div>
        
        <div class="footer-section">
            <h3 class="footer-title">üåê S√≠guenos</h3>
            <div class="footer-social">
                <a href="https://www.instagram.com/tu_idea_hecha_realidad?igsh=Y3ByM2lyZGcwNHVy" class="social-icon-img" aria-label="Instagram">
                        <img src="{% static 'core/img/Instagram.webp' %}" alt="Instagram" class="social-logo" width="40" height="40">
                    </a>
                    <a href="https://www.facebook.com/share/1ACEVZbZHV/" class="social-icon-img" aria-label="Facebook">
                        <img src="{% static 'core/img/Facebook.png' %}" alt="Facebook" class="social-logo" width="40" height="40">
                    </a>
            </div>
        </div>
    </div>
    
    <div class="footer-bottom">
        <p>¬© 2025 Tu Idea Herba Realidad - Todos los derechos reservados</p>
    </div>
  </footer>
</div>

<script src="{% static 'core/javascript/Carrito.js' %}"></script>
<script>
  function aplicarFiltros() {
        const categoria = document.getElementById('categoria').value;
        console.log('Aplicando filtros y redirigiendo...');
        console.log('Categor√≠a seleccionada:', categoria);

        if (categoria) {
            const urlRedireccion = '/' + categoria + '/';
            
            console.log('Redirigiendo a:', urlRedireccion);
            window.location.href = urlRedireccion;
        } else {
            window.location.href = '/productos/'; 
        }
    }

  // Funci√≥n para responder a la empresa
  function responderEmpresa(ideaId) {
    const respuesta = prompt('Escribe tu respuesta a la empresa:');
    if (respuesta && respuesta.trim()) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const formData = new FormData();
      formData.append('respuesta', respuesta.trim());
      
      fetch(`/idea/responder/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar la respuesta');
      });
    }
  }

  // Funci√≥n para otorgar permiso de publicaci√≥n
  function otorgarPermiso(ideaId) {
    if (confirm('¬øEst√°s seguro de que deseas otorgar permiso a la empresa para publicar tu idea como producto en la tienda?')) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(`/idea/otorgar-permiso/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al otorgar el permiso');
      });
    }
  }

  // Funci√≥n para revocar permiso de publicaci√≥n
  function revocarPermiso(ideaId) {
    if (confirm('¬øEst√°s seguro de que deseas revocar el permiso de publicaci√≥n?')) {
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
      fetch(`/idea/revocar-permiso/${ideaId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert(data.mensaje);
          location.reload();
        } else {
          alert('Error: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error al revocar el permiso');
      });
    }
  }

// Medidas y recomendaciones por categor√≠a
const CATEGORIA_MEDIDAS = {
  mesas: {
    campos: [
      {nombre: 'Altura de la Superficie', campo: 'altura_superficie', unidad: 'cm', estandar: '73 - 75'},
      {nombre: 'Profundidad de Escritorio (Min.)', campo: 'profundidad_escritorio', unidad: 'cm', estandar: '60'},
      {nombre: 'Espacio Libre para Piernas (Altura)', campo: 'espacio_piernas', unidad: 'cm', estandar: '65 (m√≠nimo)'},
      {nombre: 'Ancho por Persona (Comedor)', campo: 'ancho_persona', unidad: 'cm', estandar: '60 (m√≠nimo)'}
    ],
    recomendacion: 'La altura es crucial para la ergonom√≠a; la diferencia ideal entre la mesa y el asiento de la silla es de <b>30 cm</b>.'
  },
  sillas: {
    campos: [
      {nombre: 'Altura del Asiento', campo: 'altura_asiento', unidad: 'cm', estandar: '40 - 45'},
      {nombre: 'Profundidad del Asiento', campo: 'profundidad_asiento', unidad: 'cm', estandar: '42 - 49'},
      {nombre: 'Ancho del Asiento (Min.)', campo: 'ancho_asiento', unidad: 'cm', estandar: '42'}
    ],
    recomendacion: 'La altura del asiento debe permitir que los pies toquen el suelo y las rodillas formen un √°ngulo de 90¬∞. Debe haber soporte lumbar.'
  },
  armarios: {
    campos: [
      {nombre: 'Profundidad Total (Ropa Colgada)', campo: 'profundidad_total', unidad: 'cm', estandar: '55 - 60'},
      {nombre: 'Altura Libre para Ropa Corta', campo: 'altura_ropa_corta', unidad: 'cm', estandar: '90 - 110'},
      {nombre: 'Altura Libre para Ropa Larga', campo: 'altura_ropa_larga', unidad: 'cm', estandar: '150 - 170'},
      {nombre: 'Altura de Estantes (Separaci√≥n)', campo: 'altura_estantes', unidad: 'cm', estandar: '30 - 40'}
    ],
    recomendacion: 'La profundidad de 60 cm es la necesaria para que una percha cuelgue sin que la ropa choque contra la puerta.'
  },
  cajoneras: {
    campos: [
      {nombre: 'Profundidad Total', campo: 'profundidad_total', unidad: 'cm', estandar: '40 - 60'},
      {nombre: 'Altura Frontal de Caj√≥n Chico', campo: 'altura_cajon_chico', unidad: 'cm', estandar: '10 - 15'},
      {nombre: 'Altura Frontal de Caj√≥n Grande', campo: 'altura_cajon_grande', unidad: 'cm', estandar: '20 - 30'}
    ],
    recomendacion: 'Se requiere una buena calidad de <b>correderas</b> que soporten la carga y permitan la extracci√≥n completa del caj√≥n.'
  },
  escritorios: {
    campos: [
      {nombre: 'Altura de la Superficie', campo: 'altura_superficie', unidad: 'cm', estandar: '70 - 75'},
      {nombre: 'Profundidad', campo: 'profundidad', unidad: 'cm', estandar: '60 - 80'},
      {nombre: 'Ancho (M√≠nimo)', campo: 'ancho', unidad: 'cm', estandar: '100 - 120'}
    ],
    recomendacion: 'Debe proporcionar suficiente profundidad para mantener la pantalla a una distancia c√≥moda y tener espacio para apoyar los antebrazos.'
  },
  utensilios: {
    campos: [],
    recomendacion: ''
  }
};

const categoriaSelect = document.getElementById('id_categoria');
const medidasSection = document.getElementById('medidas-section');
const medidasCampos = document.getElementById('medidas-campos');
const medidasRecomendacion = document.getElementById('medidas-recomendacion');
const medidasInput = document.getElementById('id_medidas');
const medidasError = document.getElementById('medidas-error');

function renderMedidasCampos(categoria) {
  medidasCampos.innerHTML = '';
  medidasError.style.display = 'none';
  if (!categoria || !CATEGORIA_MEDIDAS[categoria] || CATEGORIA_MEDIDAS[categoria].campos.length === 0) {
    medidasSection.style.display = 'none';
    medidasInput.value = '';
    medidasRecomendacion.innerHTML = '';
    return;
  }
  medidasSection.style.display = 'block';
  CATEGORIA_MEDIDAS[categoria].campos.forEach(function(campo) {
    const div = document.createElement('div');
    div.className = 'medida-campo';
    div.style.display = 'flex';
    div.style.flexDirection = 'column';
    div.style.alignItems = 'center';
    div.style.marginBottom = '12px';
    div.innerHTML = `<label style='margin-bottom:4px;'><b>${campo.nombre}</b> <span style='color:#888;'>(Estandar: ${campo.estandar} ${campo.unidad})</span></label><input type='number' min='0' step='any' class='input-medida' name='${campo.campo}' placeholder='Tu medida en ${campo.unidad}' required style='margin-bottom:8px; text-align:center; width: 220px;'> <span>${campo.unidad}</span>`;
    medidasCampos.appendChild(div);
  });
  medidasRecomendacion.innerHTML = `<div class='recomendacion-box'><b>Recomendaci√≥n:</b> ${CATEGORIA_MEDIDAS[categoria].recomendacion}</div>`;
}

categoriaSelect.addEventListener('change', function() {
  renderMedidasCampos(this.value);
});

// Validaci√≥n antes de enviar
const ideaForm = document.getElementById('ideaForm');
ideaForm.addEventListener('submit', function(e) {
  const categoria = categoriaSelect.value;
  if (!categoria || !CATEGORIA_MEDIDAS[categoria]) return;
  const campos = CATEGORIA_MEDIDAS[categoria].campos;
  let medidas = {};
  let incompletos = [];
  campos.forEach(function(campo) {
    const input = ideaForm.querySelector(`[name='${campo.campo}']`);
    if (!input || !input.value) {
      incompletos.push(campo.nombre);
    } else {
      medidas[campo.campo] = input.value;
    }
  });
  if (incompletos.length > 0) {
    e.preventDefault();
    medidasError.innerText = 'Termina de adjuntar las medidas necesarias para poder publicar tu idea.';
    medidasError.style.display = 'block';
    return false;
  }
  medidasInput.value = JSON.stringify(medidas);
  medidasError.style.display = 'none';
});
// Render inicial si hay valor
if (categoriaSelect.value) renderMedidasCampos(categoriaSelect.value);
</script>

<script src="{% static 'core/javascript/sidebar-toggle.js' %}"></script>
{% include 'core/floating_buttons.html' %}
{% include 'core/modal_notificaciones.html' %}
</body>
</html>
